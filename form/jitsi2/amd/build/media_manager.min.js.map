{"version":3,"file":"media_manager.min.js","sources":["../src/media_manager.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/ //\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * Plenary meeting Jitsi integration media manager\n *\n * @package    plenumform_jitsi2\n * @module     plenumform_jitsi2/media_manager\n * @copyright  2025 Daniel Thies\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nvar domain;\n\nimport Ajax from \"core/ajax\";\nimport {get_string as getString} from \"core/str\";\nimport JitsiMeetJS from \"plenumform_jitsi2/lib-jitsi-meet.min\";\nimport Notification from \"core/notification\";\nimport Templates from \"core/templates\";\n\nexport default class MediaManager {\n    /**\n     * Initialize player plugin\n     *\n     * @param {int} contextid\n     * @param {int} delay\n     * @param {string} server Jitsi server to use\n     * @param {string} room Room name\n     * @param {object} userinfo User information to pass to meeting\n     * @param {string} jwt JWT authentication token\n     *\n     * @returns {bool}\n     */\n    constructor(contextid, delay, server, room, userinfo, jwt) {\n        this.contextid = contextid;\n        domain = server;\n        this.userinfo = [];\n        this.displayedTracks = [];\n        this.videoTracks = {};\n        this.audioTracks = {};\n\n        if (delay) {\n            setInterval(() => {\n                this.updateMotions(contextid);\n            }, delay);\n        }\n\n        JitsiMeetJS.init();\n        JitsiMeetJS.setLogLevel(JitsiMeetJS.logLevels.DEBUG);\n\n        this.connection = new JitsiMeetJS.JitsiConnection(null, jwt, {\n            serviceUrl: `https://${ domain }/http-bind`,\n            hosts: {\n                domain: domain,\n                muc: `conference.${ domain }`\n            }\n        });\n        this.connection.addEventListener(JitsiMeetJS.events.connection.CONNECTION_ESTABLISHED, () => {\n            this.room = this.connection.initJitsiConference(room, {\n                disableSimulcast: true\n            });\n            this.room.addEventListener(JitsiMeetJS.events.conference.TRACK_ADDED, track => {\n                this.onRemoteTrack(track);\n            });\n            this.room.addEventListener(JitsiMeetJS.events.conference.TRACK_REMOVED, track => {\n                track.dispose();\n            });\n            this.room.addCommandListener('updatecontent', () => {\n                this.updateMotions(contextid);\n            });\n            this.room.on(JitsiMeetJS.events.conference.CONFERENCE_JOINED, () => {\n                this.updateMotions(contextid);\n            });\n\n            document.body.addEventListener(\n                'motioncreated',\n                () => {\n                    this.room.sendCommandOnce('updatecontent', {\n                        value: 'updatecontent',\n                        attributes: {},\n                        children: []\n                    });\n                }\n            );\n            document.body.addEventListener(\n                'motionupdated',\n                () => {\n                    this.room.sendCommandOnce('updatecontent', {\n                        value: 'updatecontent',\n                        attributes: {},\n                        children: []\n                    });\n                }\n            );\n\n            this.room.join();\n        });\n        this.connection.addEventListener(JitsiMeetJS.events.connection.CONNECTION_DISCONNECTED, () => {\n            Notification.alert(\n                getString('disconnected', 'plenumform_jitsi2'),\n                getString('disconnectedmessage', 'plenumform_jitsi2')\n            );\n        });\n\n        this.connection.connect();\n\n        document.addEventListener('click', e => {\n            this.handleClick(e);\n        });\n        document.body.addEventListener('click', e => {\n            this.muteAudio(e);\n        });\n\n        return true;\n    }\n\n    /**\n     * Update motions\n     *\n     * @param {int} contextid\n     */\n    async updateMotions(contextid) {\n        const selector = `[data-contextid=\"${contextid}\"][data-region=\"plenum-motions\"]`;\n        const content = document.querySelector(selector);\n        if (content) {\n            const response = await Ajax.call([{\n                args: {\n                    contextid: contextid\n                },\n                contextid: contextid,\n                fail: Notification.exception,\n                methodname: 'plenumform_jitsi2_update_content'\n            }])[0];\n            if (response.motions) {\n                Templates.replaceNodeContents(content, response.motions, response.javascript);\n                this.userinfo = response.userinfo;\n                this.updateMedia();\n            }\n            if (response.controls) {\n                const selector = `[data-contextid=\"${contextid}\"][data-region=\"plenum-deft-controls\"]`;\n                Templates.replaceNodeContents(selector, response.controls, '');\n            }\n            if (!response.sharevideo) {\n                this.room.getLocalTracks().forEach(track => {\n                    track.dispose();\n                });\n            }\n        }\n    }\n\n    /**\n     * Attach or detach media\n     */\n    updateMedia() {\n        this.displayedTracks.forEach(async track => {\n            if (!this.userinfo.find(speaker => speaker.id == track.getParticipantId())) {\n                document.querySelectorAll(\n                    `[data-region=\"slot-${ track.role }\"] ${ track.getType() }`\n                ).forEach(player => {\n                    track.detach(player);\n                });\n                delete this.displayedTracks[this.displayedTracks.indexOf(track)];\n            }\n        });\n        this.userinfo.forEach(speaker => {\n            if (this.videoTracks[speaker.id]) {\n                const track = this.videoTracks[speaker.id];\n                if (!this.displayedTracks.includes(track)) {\n                    track.role = speaker.role;\n                    track.attach(document.querySelector(`[data-region=\"slot-${ speaker.role }\"] ${ track.getType() }`));\n                    this.displayedTracks.push(track);\n                }\n            }\n            if (this.audioTracks[speaker.id]) {\n                const track = this.audioTracks[speaker.id];\n                if (!this.displayedTracks.includes(track)) {\n                    track.role = speaker.role;\n                    track.attach(document.querySelector(`[data-region=\"slot-${ speaker.role }\"] ${ track.getType() }`));\n                    this.displayedTracks.push(track);\n                }\n            }\n            document.querySelectorAll(`[data-region=\"slot-${ speaker.role }\"] .card-header`).forEach(function(h) {\n                h.innerHTML = speaker.name;\n            });\n            document.querySelectorAll(`[data-region=\"slot-${ speaker.role }\"] video`).forEach(function(video) {\n                video.poster = speaker.pictureurl;\n            });\n        });\n    }\n\n    /**\n     * Process new remote track\n     *\n     * @param {JitsiTrack} track New track\n     */\n    onRemoteTrack(track) {\n        if (track.getType() == 'video') {\n            this.videoTracks[track.getParticipantId()] = track;\n        } else {\n            this.audioTracks[track.getParticipantId()] = track;\n        }\n        this.updateMedia();\n    }\n\n    /**\n     * Change published media in activity\n     *\n     * @param {bool} publish Whether to add or remove media\n     */\n    async publish(publish) {\n        await Ajax.call([{\n            args: {\n                contextid: this.contextid,\n                id: this.room.myUserId(),\n                publish: publish\n            },\n            contextid: this.contextid,\n            fail: Notification.exception,\n            methodname: 'plenumform_jitsi2_publish_feed'\n        }])[0];\n\n        this.room.sendCommandOnce('updatecontent', {\n            value: 'updatecontent',\n            attributes: {},\n            children: []\n        });\n    }\n\n    /**\n     * Handle button click\n     *\n     * @param {Event} e Click event\n     */\n    async handleClick(e) {\n        const button = e.target.closest('button[data-action=\"publish\"], button[data-action=\"unpublish\"]');\n\n        if (!button) {\n            return;\n        }\n\n        this.room.getLocalTracks().forEach(track => {\n            track.dispose();\n        });\n\n        if (button.dataset.action == 'publish') {\n            const tracks = await JitsiMeetJS.createLocalTracks({\n                devices: ['video', 'audio'],\n                constraints: {aspectRatio: {exact: 1}, height: {ideal: 360}, width: {ideal: 360}}\n            });\n            tracks.forEach(track => {\n                if (this[`${ track.getType() }Track`]) {\n                    this.room.replaceTrack(this[`${ track.getType() }Track`], track);\n                } else {\n                    this.room.addTrack(track);\n                }\n                this[`${ track.getType() }Track`] = track;\n            });\n            this.publish(true);\n        } else {\n            this.publish(false);\n        }\n    }\n\n    /**\n     * Handle mute switch change\n     *\n     * @param {Event} e The switch event\n     */\n    muteAudio(e) {\n        const input = e.target.closest('[data-region=\"audio-control\"] input');\n        if (!input) {\n            return;\n        }\n        setTimeout(() => {\n            if (input.checked) {\n                document.querySelectorAll('[data-region=\"plenum-deft-media\"] audio').forEach(audio => {\n                    if (\n                        !this.room.getLocalTracks().length\n                        || !this.userinfo.find(speaker => (\n                            (speaker.id == this.room.myUserId())\n                            && audio.closest(`[data-region=\"slot-${ speaker.role }\"]`)\n                        ))\n                    ) {\n                        audio.volume = 1;\n                        audio.muted = '';\n                        audio.setAttribute('data-active', 'true');\n                    } else {\n                        audio.volume = 0;\n                        audio.muted = true;\n                    }\n                    audio.play();\n                });\n            } else {\n                document.querySelectorAll('audio').forEach(audio => {\n                    audio.muted = true;\n                    audio.removeAttribute('data-active');\n                });\n            }\n        });\n    }\n}\n"],"names":["domain","constructor","contextid","delay","server","room","userinfo","jwt","displayedTracks","videoTracks","audioTracks","setInterval","updateMotions","init","setLogLevel","JitsiMeetJS","logLevels","DEBUG","connection","JitsiConnection","serviceUrl","hosts","muc","addEventListener","events","CONNECTION_ESTABLISHED","this","initJitsiConference","disableSimulcast","conference","TRACK_ADDED","track","onRemoteTrack","TRACK_REMOVED","dispose","addCommandListener","on","CONFERENCE_JOINED","document","body","sendCommandOnce","value","attributes","children","join","CONNECTION_DISCONNECTED","alert","connect","e","handleClick","muteAudio","selector","content","querySelector","response","Ajax","call","args","fail","Notification","exception","methodname","motions","replaceNodeContents","javascript","updateMedia","controls","sharevideo","getLocalTracks","forEach","async","find","speaker","id","getParticipantId","querySelectorAll","role","getType","player","detach","indexOf","includes","attach","push","h","innerHTML","name","video","poster","pictureurl","publish","myUserId","button","target","closest","dataset","action","createLocalTracks","devices","constraints","aspectRatio","exact","height","ideal","width","replaceTrack","addTrack","input","setTimeout","checked","audio","length","volume","muted","setAttribute","play","removeAttribute"],"mappings":"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"}